<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>TikTok Live Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body { padding: 1rem; }
    .panel { height: 250px; overflow-y: auto; }
  </style>
</head>
<body class="container">
  <h1 class="mb-4">TikTok Live å®æ—¶çœ‹æ¿</h1>

  <!-- ç¬¬ä¸€è¡Œï¼šè¾“å…¥ (8) + é’»çŸ³ (4) -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="input-group">
        <input id="targetInput" type="text" class="form-control"
               placeholder="è¾“å…¥ @ç”¨æˆ·å æˆ– å®Œæ•´ç›´æ’­ URL"/>
        <button id="listenBtn" class="btn btn-primary">å¼€å§‹ç›‘å¬</button>
        <span class="input-group-text" id="currentTarget">æœªç›‘å¬</span>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-center">
        <div class="card-header">ğŸ’ ç´¯è®¡é’»çŸ³</div>
        <div class="card-body"><h2 id="diamonds">0</h2></div>
      </div>
    </div>
  </div>

  <!-- ç¬¬äºŒè¡Œï¼šè¯„è®º (8) + ç¤¼ç‰© (4) -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">ğŸ’¬ æœ€æ–°è¯„è®º</div>
        <div class="card-body panel">
          <ul id="comments" class="list-unstyled mb-0"></ul>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">ğŸ é€ç¤¼è®°å½•</div>
        <div class="card-body panel">
          <ul id="gifts" class="list-unstyled mb-0"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¬¬ä¸‰è¡Œï¼šè¿›æˆ¿ (6) + å…³æ³¨ (6) -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">ğŸšª æ–°è¿›æˆ¿</div>
        <div class="card-body panel">
          <ul id="joins" class="list-unstyled mb-0"></ul>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">â• æ–°å¢å…³æ³¨</div>
        <div class="card-body panel">
          <ul id="follows" class="list-unstyled mb-0"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io("http://localhost:8000", { path: "/ws/socket.io" });
    const COMMENT_LIMIT = 100, JOIN_LIMIT = 50, FOLLOW_LIMIT = 50;
    let alertAudioMap = {}, giftNameMap = {};

    // ç¦ç”¨ç¼“å­˜åŠ è½½ JSON é…ç½®
    fetch('/static/alert_gifts.json', { cache: 'no-store' })
      .then(r => r.json())
      .then(cfg => {
        cfg.alertGifts.forEach(({gift_id,audio_src}) => {
          const a = document.createElement('audio');
          a.id = `audio-${gift_id}`; a.src = audio_src;
          document.body.appendChild(a);
          alertAudioMap[gift_id] = a;
        });
      });

    fetch('/static/gift_names.json', { cache: 'no-store' })
      .then(r => r.json())
      .then(cfg => { giftNameMap = cfg; });

    // åˆ‡æ¢ç›‘å¬ç›®æ ‡
    document.getElementById("listenBtn").onclick = async () => {
      const tgt = document.getElementById("targetInput").value.trim();
      if (!tgt) return alert("è¯·è¾“å…¥ç›®æ ‡");
      const res = await fetch("/api/listen", {
        method: "POST", headers: {"Content-Type":"application/json"},
        body: JSON.stringify({target:tgt})
      });
      const j = await res.json();
      document.getElementById("currentTarget").innerText = j.listening;
      ["comments","gifts","joins","follows"].forEach(id => {
        document.getElementById(id).innerHTML = "";
      });
      document.getElementById("diamonds").innerText = "0";
    };

    // è¯„è®º
    socket.on("comment", data => {
      const ul = document.getElementById("comments");
      const li = document.createElement("li");
      li.textContent = `${data.nickname}: ${data.comment}`;
      ul.prepend(li);
      if (ul.children.length > COMMENT_LIMIT) ul.removeChild(ul.lastChild);
    });

    // æ™®é€šç¤¼ç‰©
    socket.on("gift", data => {
      if (alertAudioMap[data.gift_id]) alertAudioMap[data.gift_id].play().catch(()=>{});
      const name = giftNameMap[data.gift_id]||data.gift_name;
      const ul   = document.getElementById("gifts");
      const li   = document.createElement("li");
      li.textContent = `${data.nickname} â†’ ${name} x${data.count} (é’»çŸ³: ${data.diamond})`;
      ul.prepend(li);
    });

    // è¿å‡»ç¤¼ç‰©
    socket.on("combo_gift", data => {
      if (alertAudioMap[data.gift_id]) alertAudioMap[data.gift_id].play().catch(()=>{});
      const name = giftNameMap[data.gift_id]||data.gift_name;
      const ul   = document.getElementById("gifts");
      const li   = document.createElement("li");
      li.classList.add("text-warning");
      li.textContent = `${data.nickname} â†’ ${name} è¿å‡» ${data.combo_count} æ¬¡ (é’»çŸ³: ${data.combo_diamond})`;
      ul.prepend(li);
    });

    // é’»çŸ³æ€»æ•°æ›´æ–°
    socket.on("diamonds", d => {
      document.getElementById("diamonds").innerText = d.total_diamonds;
    });

    // è¿›æˆ¿
    socket.on("join", data => {
      const ul = document.getElementById("joins");
      const li = document.createElement("li");
      li.textContent = `${data.nickname} è¿›å…¥ç›´æ’­é—´`;
      ul.prepend(li);
      if (ul.children.length > JOIN_LIMIT) ul.removeChild(ul.lastChild);
    });

    // å…³æ³¨
    socket.on("follow", data => {
      const ul = document.getElementById("follows");
      const li = document.createElement("li");
      li.textContent = `${data.nickname} å…³æ³¨äº†`;
      ul.prepend(li);
      if (ul.children.length > FOLLOW_LIMIT) ul.removeChild(ul.lastChild);
    });
  </script>
</body>
</html>
